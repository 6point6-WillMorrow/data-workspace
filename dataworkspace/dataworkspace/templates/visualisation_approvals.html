{% extends '_visualisation.html' %}
{% load core_filters %}

{% block head %}
{{ block.super }}
{{ form.media }}
{% endblock %}

{% block page_title %}{% if form.errors %}Error: {% endif %}Catalogue item - {{ block.super }}{% endblock %}

{% block content %}
{% if form_errors %}
<div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="govuk-error-summary">
  <h2 class="govuk-error-summary__title" id="error-summary-title">
    There is a problem
  </h2>
  <div class="govuk-error-summary__body">
    <ul class="govuk-list govuk-error-summary__list">
    {% for id_for_label, error in form_errors %}
        <li>
          <a href="{{ request.path }}#{{ id_for_label }}">{{ error }}</a>
        </li>
    {% endfor %}
    </ul>
  </div>
</div>
{% endif %}

<h1 class="govuk-heading-l govuk-!-margin-bottom-6">
  <span class="govuk-caption-l">{{ gitlab_project.name }}</span>
  Approvals
</h1>

<p class="govuk-body">
  In order to publish this visualisation, at least two users must approve it.
</p>

<p class="govuk-body">
  {% if approvals %}
  So far, the following {{ approvals | length }} user{{ approvals | pluralize }} {{ approvals | pluralize:'has,have' }} approved it.
  {% else %}
  No-one has approved this yet.
  {% endif %}
</p>

<ul class="govuk-list govuk-list--bullet">
  {% for approval in approvals %}
    <li>{% if request.user == approval.approver %}You{% else %}{{ approval.approver.get_full_name }}{% endif %} approved this visualisation at {{ approval.created_date }}</li>
  {% endfor %}
</ul>

<hr class="govuk-section-break govuk-section-break--l govuk-section-break--visible">

<form method="POST" action="{{ request.path }}" novalidate>
  {% csrf_token %}

  {{ form.non_field_errors }}

  {{ form.visualisation }}
  {{ form.approver }}

  {% if already_approved %}

  {% comment "We render this as a hiddenfield for the unapprove state" %}{% endcomment %}
  {{ form.approved }}
  <input type="submit" class="govuk-button" value="Unapprove" />

  {% else %}

  {% include "partials/govuk_single_checkbox_field.html" with field=form.approved %}
  <input type="submit" class="govuk-button" value="Approve" />

  {% endif %}
 </form>
{% endblock %}
