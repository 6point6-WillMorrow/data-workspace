{% extends '_main.html' %}
{% load humanize %}
{% load static %}
{% load core_filters %}
{% load core_tags %}
{% load datasets_tags %}
{% load waffle_tags %}

{% block head %}
    {{ block.super }}
    <script nonce="{{ request.csp_nonce }}" src="{% static 'jquery-3.4.1.min.js' %}"></script>
    <script nonce="{{ request.csp_nonce }}" src="{% static 'gtm-support.js' %}"></script>
{% endblock %}

{% block initialGTMDataLayer %}
  {{ block.super }}
  <script nonce="{{ request.csp_nonce }}">
    dataLayer.push(
      {
        "event": "filter",
        "searchTerms": "{{ query }}",
        "resultsReturned": {{ datasets.paginator.count }},
        {% for field in form %}
          {% if field.field|is_choice_field %}
        "filterData{{ field.name | title }}": "{{ field | get_choice_field_data_for_gtm }}"{% if not forloop.last %},{% endif %}
          {% endif %}
        {% endfor %}
      }
    )
  </script>
{% endblock %}

{% block page_title %}Search - {{ block.super }}{% endblock %}

{% block content %}

<form id="live-search-form" action="{% url 'datasets:find_datasets' %}" method="get">

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <h1 class="govuk-heading-xl">Search Data Workspace</h1>
    <p class="govuk-body-l">
      Data Workspace is where DIT staff and partners can access, analyse and securely share data and data visualisations relevant to DIT.
    </p>
  </div>

    <div class="govuk-grid-column-two-thirds">
      <div class="govuk-hint">
        Search in data name and description
      </div>
      <div class="search-field govuk-!-margin-bottom-9">
        <label class="govuk-label search-field__label" for="search">Enter your search term(s)</label>
        <div class="search-field-wrapper">
          <input type="search" name="q" id="search" title="Search" class="govuk-input search-field__item search-field__input js-class-toggle" value="{{ query }}" aria-controls="search-summary-accessible-hint-wrapper">
          <div class="search-field-submit-wrapper search-field__item">
            <input class="search-field__submit" type="submit" value="Search">
          </div>
        </div>
      </div>
    </div>
</div>

<div id="live-search-wrapper" class="govuk-grid-row">
  <div class="govuk-grid-column-one-third">
    <h2 class="govuk-heading-l">Filters</h2>
    {{ form.status }}
    {% if show_unpublished %}
      {{ form.unpublished }}
    {% endif %}
    {{ form.use }}
    {% flag FILTER_BY_TOPIC_FLAG %}
    {% if form.topic.field.choices %}
      {{ form.topic }}
    {% endif %}
    {% endflag %}
    {% if form.source.field.choices %}
      {{ form.source }}
    {% endif %}
  </div>
  <div class="govuk-grid-column-two-thirds">
    <div id="search-summary-accessible-hint-wrapper" class="govuk-visually-hidden" aria-atomic="true" aria-live="polite" aria-relevant="additions text" role="status">
      {{ datasets.paginator.count }} search results
    </div>
    <h2 class="govuk-body">
      <span id="search-results-count">{{ datasets.paginator.count }}</span> search results
    </h2>
    <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
    {{ form.sort }}
    {% for dataset in datasets %}
    <div class="search-result">
      <div class="govuk-grid-row">
        <div class="govuk-grid-column-three-quarters">
          <h3 class="govuk-heading-m">
            <a class="govuk-link" href="{% url "datasets:dataset_detail" dataset_uuid=dataset.id %}#{{ dataset.slug }}">{{ dataset.name }}</a>
          </h3>
          {% if not dataset.published %}
            <div class="govuk-!-display-inline-block" style="float: right">
              <strong class="govuk-tag govuk-tag--grey">
                Unpublished
              </strong>
            </div>
          {% endif %}
            </div>
        <div class="govuk-grid-column-one-quarter govuk-!-margin-top-2" style="text-align: right;">
          {% if dataset.is_bookmarked %}
          <svg version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" width="16px" height="18px" xmlns="http://www.w3.org/2000/svg">
            <g transform="matrix(1 0 0 1 -666 -184 )">
              <path d="M 1.45 0  L 14.55 0  C 14.7416666666667 0  14.925 0.035690680766689  15.1 0.107072042300067  C 15.375 0.210178453403831  15.59375 0.372769332452081  15.75625 0.594844679444812  C 15.91875 0.81692002643754  16 1.06278916060806  16 1.33245208195638  L 16 16.6675479180436  C 16 16.9372108393919  15.91875 17.1830799735625  15.75625 17.4051553205552  C 15.59375 17.6272306675479  15.375 17.7898215465962  15.1 17.8929279576999  C 14.9416666666667 17.9563780568407  14.7583333333333 17.9881031064111  14.55 17.9881031064111  C 14.15 17.9881031064111  13.8041666666667 17.8612029081295  13.5125 17.6074025115664  L 8 12.5631196298744  L 2.4875 17.6074025115664  C 2.1875 17.8691341705221  1.84166666666667 18  1.45 18  C 1.25833333333333 18  1.075 17.9643093192333  0.9 17.8929279576999  C 0.625 17.7898215465962  0.40625 17.6272306675479  0.24375 17.4051553205552  C 0.08125 17.1830799735625  0 16.9372108393919  0 16.6675479180436  L 0 1.33245208195638  C 0 1.06278916060806  0.08125 0.81692002643754  0.24375 0.594844679444812  C 0.40625 0.372769332452081  0.625 0.210178453403831  0.9 0.107072042300067  C 1.075 0.035690680766689  1.25833333333333 0  1.45 0  Z " fill-rule="nonzero" fill="#005ea5" stroke="none" transform="matrix(1 0 0 1 666 184 )" />
            </g>
          </svg>
          {% else %}
          <svg version="1.1" xmlns:xlink="http://www.w3.org/1999/xlink" width="16px" height="18px" xmlns="http://www.w3.org/2000/svg">
            <g transform="matrix(1 0 0 1 -666 -184 )">
              <path d="M 14.4 16.2987442167878  L 14.4 1.52280237937872  L 1.6 1.52280237937872  L 1.6 16.2987442167878  L 6.8875 11.468605419696  L 8 10.4573694646398  L 9.1125 11.468605419696  L 14.4 16.2987442167878  Z M 1.45 0  L 14.55 0  C 14.7416666666667 0  14.925 0.035690680766689  15.1 0.107072042300067  C 15.375 0.210178453403831  15.59375 0.372769332452081  15.75625 0.594844679444812  C 15.91875 0.81692002643754  16 1.06278916060806  16 1.33245208195638  L 16 16.6675479180436  C 16 16.9372108393919  15.91875 17.1830799735625  15.75625 17.4051553205552  C 15.59375 17.6272306675479  15.375 17.7898215465962  15.1 17.8929279576999  C 14.9416666666667 17.9563780568407  14.7583333333333 17.9881031064111  14.55 17.9881031064111  C 14.15 17.9881031064111  13.8041666666667 17.8612029081295  13.5125 17.6074025115664  L 8 12.5631196298744  L 2.4875 17.6074025115664  C 2.1875 17.8691341705221  1.84166666666667 18  1.45 18  C 1.25833333333333 18  1.075 17.9643093192333  0.9 17.8929279576999  C 0.625 17.7898215465962  0.40625 17.6272306675479  0.24375 17.4051553205552  C 0.08125 17.1830799735625  0 16.9372108393919  0 16.6675479180436  L 0 1.33245208195638  C 0 1.06278916060806  0.08125 0.81692002643754  0.24375 0.594844679444812  C 0.40625 0.372769332452081  0.625 0.210178453403831  0.9 0.107072042300067  C 1.075 0.035690680766689  1.25833333333333 0  1.45 0  Z " fill-rule="nonzero" fill="#005ea5" stroke="none" transform="matrix(1 0 0 1 666 184 )" />
            </g>
          </svg>
          {% endif %}
        </div>
      </div>
      <p class="govuk-body">{{ dataset.short_description }}</p>
      <p class="govuk-body">
        <span class="govuk-!-font-weight-bold">Purpose:</span> {{ purpose|get_key:dataset.purpose}}
        <br>
        <span class="govuk-!-font-weight-bold">Source:</span> 
        {% if dataset.source_tag_names|length > 1 %}
          {{ dataset.source_tag_names|join:", " }}
        {% else %}
          {{ dataset.source_tag_names.0|default:"N/A" }}
        {% endif %}
      </p>

      {% flag FILTER_BY_TOPIC_FLAG %}
      {% if dataset.topic_tag_names|length > 0 %}
        <p class="govuk-visually-hidden">Topics</p>
        <span class="govuk-body govuk-!-margin-bottom-0 govuk-!-margin-top-2">
          <ul class="app-taglist govuk-body govuk-!-margin-0">
            {% for tag_name in dataset.topic_tag_names %}
              <li class="app-taglist__item govuk-!-font-weight-bold govuk-!-font-size-16">{{ tag_name }}</li>
            {% endfor %}
          </ul>
        </span>
      {% endif %}
      {% endflag %}

    </div>
    {% endfor %}

    <p class="govuk-body" style="display: inline">
      Displaying datasets {{ datasets.start_index  }}&ndash;{{ datasets.end_index }} of {{ datasets.paginator.count }}
    </p>

    {% if datasets.paginator.num_pages > 1 %}
    <nav role="navigation" class="govuk-body" aria-label="Search result page navigation" style="display: inline">
      <ul class="pagination govuk-list">
        {% if datasets.has_previous %}
          <li><a class="govuk-link" href="{% url_replace page=datasets.previous_page_number %}" aria-label="Previous page">Previous</a></li>
        {% endif %}

        {% if datasets.number > 3 %}
          <li><a class="govuk-link" href="{% url_replace page=1 %}" aria-label="Page 1">{{ 1 }}</a></li>
          {% if datasets.number > 4 %}<li>&hellip;</li>{% endif %}
        {% endif %}

        {% for i in datasets.paginator.page_range %}
          {% if datasets.number == i %}
            <li class="active">{{ i }}</li>
          {% elif i >= datasets.number|add:'-2' and i <= datasets.number|add:'2' %}
            <li><a class="govuk-link" href="{% url_replace page=i %}" aria-label="Page {{ i }}">{{ i }}</a></li>
          {% endif %}
        {% endfor %}

        {% if datasets.paginator.num_pages > datasets.number|add:'2' %}
          {% if datasets.paginator.num_pages > datasets.number|add:'3' %}<li>&hellip;</li>{% endif %}
          <li><a class="govuk-link" href="{% url_replace page=datasets.paginator.num_pages %}" aria-label="Page {{ datasets.paginator.num_pages }}">{{ datasets.paginator.num_pages }}</a></li>
        {% endif %}

        {% if datasets.has_next %}
          <li><a class="govuk-link" href="{% url_replace page=datasets.next_page_number %}" aria-label="Next page">Next</a></li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}

    <div {% if datasets.paginator.count %}class="govuk-!-margin-top-9"{% endif %}>
      <p class="govuk-body">
        {% if datasets.paginator.count %}
          If you haven’t found what you’re looking for, please:
        {% else %}
          There are no results for your search, please:
        {% endif %}
      </p>
      <ul class="govuk-list govuk-list--bullet">
        <li>check the spelling of your keywords</li>
        <li>use more general keywords</li>
        <li>select or deselect different filters</li>
        <li><a class="govuk-link" href="{% url 'request_data:index' %}?tag=data-request">ask for us to add the dataset</a></li>
      </ul>
    </div>
  </div>
</div>
</form>
{% endblock %}

{% block footer_scripts %}
  {% if form.source.field.choices %}
    {{ form.media }}
  {% endif %}

  <script nonce="{{ request.csp_nonce }}" src="{% static 'search-v2.js' %}"></script>
  <script nonce="{{ request.csp_nonce }}">
    $(document).ready(function() {
      var form = new LiveSearch('#live-search-form', '#live-search-wrapper', new GTMDatasetSearchSupport());
      var searchInput = new ToggleInputClassOnFocus($("#live-search-form"))
    });
  </script>
{% endblock %}
